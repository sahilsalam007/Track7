<%- include("../../views/partials/user/header") %>
<style>

  .dashboard-menu {
      background-color: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 0 10px rgba(225, 16, 16, 0.13);
  }
  .main {

    margin-bottom: 40px; 
    padding: 0;          
}

  .dashboard-menu .nav-link {
      font-weight: 500;
      color: #333;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
  }

  .dashboard-menu .nav-link.active,
  .dashboard-menu .nav-link:hover {
      background-color: #f5f5f5;
      color: #e03333;
  }

  .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(225, 16, 16, 0.13);
      background-color: white;
  }

  .card-header {
      background-color: #e54545;
      color: white;
      border-radius: 15px 15px 0 0;
      padding: 1rem;
      font-weight: 600;
  }

  .btn-success {
      background-color: black;
      border: none;
      padding: 12px 24px;
      transition: background-color 0.3s ease;
  }

  .btn-success:hover {
      background-color: #e03636;
  }

  .form-group label {
      color: #555;
      font-weight: 500;
      margin-bottom: 8px;
  }

  .table {
      background-color: white;
      border-radius: 15px;
      overflow: hidden;
  }

  .table thead th {
      background-color: #f5f5f5;
      color: #333;
      font-weight: 600;
  }

  .btn-small {
      padding: 8px 16px;
      background-color: #f5f5f5;
      color: #333;
      border-radius: 8px;
      transition: all 0.3s ease;
  }

  .btn-small:hover {
      background-color: #ed3131;
      color: white;
      text-decoration: none;
  }

  .address {
      background-color: #f5f5f5;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
      .main {
          margin-top: 80px;
      }

      .dashboard-menu {
          margin-bottom: 1.5rem;
      }
  }

  .profile-info {
      padding: 2rem;
  }

  .profile-info p {
      margin-bottom: 1rem;
      color: #555;
  }

  .profile-info strong {
      color: #333;
      min-width: 100px;
      display: inline-block;
  }

  .nav-tabs {
      border-bottom: 2px solid #eee;
  }

  .tab-content {
      padding: 0;
  }

  .table tbody tr {
        transition: background-color 0.3s ease;
  }

  .table tbody tr:hover {
        background-color: #f8f9fa;
  }

  .text-danger {
        color: #dc3545 !important;
  }
</style>

<main class="main">
  <div class="page-header breadcrumb-wrap mb-3">
    <div class="container">
      <div class="breadcrumb">
        <a href="#" rel="nofollow">Home</a>
        <span></span> Profile <span></span> Account
      </div>
    </div>
  </div>
  <section class="pt-10 pb-10">
   <div class="container">
     <div class="row">
       <div class="col-lg-10 m-auto">
         <div class="row">
           <div class="col-md-4">
             <div class="dashboard-menu">
               <ul class="nav flex-column" role="tablist">
                 <li class="nav-item">
                   <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                     <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true">
                     <i class="fi-rs-marker mr-10"></i>My Address
                   </a>
                 </li>
                 <a class="nav-link" id="orders-tab" href="/orders">
                  <i class="fi-rs-shopping-bag mr-10"></i>Orders
                </a>
                
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" href="/logout">
                     <i class="fi-rs-sign-out mr-10"></i>Logout
                   </a>
                 </li>
               </ul>
             </div>
           </div>
           <div class="col-md-8">
             <div class="tab-content dashboard-content">


               <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                 <div class="card card-green">
                   <div class="card-header">
                     <h5 class="mb-0 text-center">User Profile</h5>
                   </div>
                   <div class="card-body text-center">
                     <h5 class="card-title"><%=user.name%></h5>
                     <p class="card-text">
                       <strong>Phone:</strong><%=user.phone%>
                     </p>
                     <p class="card-text">
                       <strong>Email:</strong><%=user.email%>
                     </p>
                     <a href="/change-email" class="btn btn-sm btn-success ml-2">Change Email</a>
                     <a href="/change-password" class="btn btn-sm btn-success">Change Password</a>
                   </div>
                 </div>
               </div>


               <div
                 class="tab-pane fade"
                 id="address"
                 role="tabpanel"
                 aria-labelledby="address-tab"
               >
                 <div class="row">
                  <%if(userAddress) {%>
                     <%userAddress.address.forEach((address)=>{%>
                   <div class="col-lg-6">
                     <div class="card mb-3 mb-lg-0">
                       <div class="card-header">
                         <h5 class="mb-0"><%=address.addressType%></h5>
                       </div>


                       <div class="card-body">
                         <address>
                           <%=address.name%><br/>
                           <%=address.city%><br/>
                           <%=address.landMark%><br/>
                           <%=address.state%><br/>
                         </address>
                         <p><%=address.pincode%></p>
                         <p><%=address.phone%></p>
                         <p><%=address.altPhone%></p>
                      
                         <div class="d-flex justify-content-between">
                           <a href="/editAddress?id=<%=address._id%>" class="btn-small">Edit</a>
                           <a href="/deleteAddress?id=<%=address._id%>" class="btn-small" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                         </div>
                        
                       </div>
                     </div>
                   </div>
                   <%})%><%}else{%>
                
                   <div class="col-lg-6">
                     <div class="card mb-3 mb-lg-0">
                       <div class="card-header">
                         <h5 class="mb-0"></h5>
                       </div>
                       <div class="card-body">
                         <address>No address</address>
                       </div>
                     </div>
                   </div>
                   <%}%>
              
                   <div>
                     <a href="/addAddress">
                       <button class="btn btn-primary w-70">
                         Add address
                       </button>
                     </a>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Your Orders</h5>
                   </div>
                   <div class="card-body">
                     <div class="table-responsive">
                       <table class="table">
                         <thead>
                           <tr>
                             <th>Order</th>
                             <th>Status</th>
                             <th>Total</th>
                             <th>Actions</th>
                           </tr>
                         </thead>
                         <tbody>
                           <tr>
                             <td></td>
                             <td></td>
                             <td></td>
                             <td>
                               <a href="" class="btn-small d-block">View</a>
                             </td>
                           </tr>
                         </tbody>
                       </table>
                     </div>
                   </div>
                 </div>
               </div>


               

               <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="orders-tab">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Wallet Balance: ₹<%= wallet && wallet.balance ? wallet.balance.toFixed(2) : '0.00' %></h5>
                    </div>
                    <div class="card-body">
                        <% if (wallet && wallet.transactions && wallet.transactions.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table" id="transactions-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-body">
                                        <% wallet.transactions.forEach(transaction => { %>
                                            <tr>
                                                <td><%= new Date(transaction.createdAt).toLocaleDateString() %></td>
                                                <td>
                                                    <% if (transaction.type === 'credit') { %>
                                                        <span style="color: #98780d; font-weight: 500;">Credit</span>
                                                    <% } else { %>
                                                        <span class="text-danger" style="font-weight: 500;">Debit</span>
                                                    <% } %>
                                                </td>
                                                <td>₹<%= transaction.amount.toFixed(2) %></td>
                                                <td><%= transaction.description %></td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center" id="pagination-controls">

                                </ul>
                            </nav>
                        <% } else { %>
                            <p class="text-center text-muted">No transactions available.</p>
                        <% } %>
                    </div>
                </div>
            </div>
            


               <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Refer a Friend</h5>
                   </div>
                   <div class="card-body">
                     <h6 class="mb-3">Invite your friends and earn wallet credits!</h6>
               
                     <p>Share your referral link:</p>
                     <div class="input-group mb-3">
                       <input type="text" id="referralLink" class="form-control" value="<%= referralLink %>" readonly>
                       <button class="btn btn-success" type="button" onclick="copyReferral()">Copy</button>
                     </div>
               
                     <p><strong>Total Referral Earnings:</strong> ₹<%= user.walletAmount || 0 %></p>
               
                     <p class="text-muted">You will earn ₹50 for every friend who signs up using your link, and they get ₹30 bonus!</p>
                   </div>
                 </div>
               </div>

       </div>
     </div>
   </div>
 </section>
</main>
<script>
document.addEventListener("DOMContentLoaded", function () {
    let ordersTab = document.getElementById("orders-tab");
    if (ordersTab) {
        ordersTab.addEventListener("click", function () {
            window.location.href = "/orders"; 
        });
    }
});



</script>
<script>
  const transactions = <%- JSON.stringify(wallet.transactions) %>;

  const transactionsPerPage = 10; 
  let currentPage = 1; 
  function renderTransactions(page) {
      const start = (page - 1) * transactionsPerPage;
      const end = start + transactionsPerPage;
      const transactionsToShow = transactions.slice(start, end);

      const tbody = document.getElementById('transactions-body');
      tbody.innerHTML = ''; 

      transactionsToShow.forEach(transaction => {
          const row = document.createElement('tr');
          row.innerHTML = `
              <td>${new Date(transaction.createdAt).toLocaleDateString()}</td>
              <td>${transaction.type === 'credit' ? '<span style="color: #98780d; font-weight: 500;">Credit</span>' : '<span class="text-danger" style="font-weight: 500;">Debit</span>'}</td>
              <td>₹${transaction.amount.toFixed(2)}</td>
              <td>${transaction.description}</td>
          `;
          tbody.appendChild(row);
      });
  }

  function renderPagination() {
      const totalPages = Math.ceil(transactions.length / transactionsPerPage);
      const paginationControls = document.getElementById('pagination-controls');
      paginationControls.innerHTML = ''; 
      const prevButton = document.createElement('li');
      prevButton.classList.add('page-item');
      prevButton.innerHTML = `
          <a class="page-link" href="#" aria-label="Previous" onclick="changePage(currentPage - 1)">
              <span aria-hidden="true">&laquo;</span>
          </a>
      `;
      if (currentPage === 1) prevButton.classList.add('disabled');
      paginationControls.appendChild(prevButton);

      for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement('li');
          pageButton.classList.add('page-item');
          pageButton.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
          if (i === currentPage) pageButton.classList.add('active');
          paginationControls.appendChild(pageButton);
      }
      const nextButton = document.createElement('li');
      nextButton.classList.add('page-item');
      nextButton.innerHTML = ` 
          <a class="page-link" href="#" aria-label="Next" onclick="changePage(currentPage + 1)">
              <span aria-hidden="true">&raquo;</span>
          </a>
      `;
      if (currentPage === totalPages) nextButton.classList.add('disabled');
      paginationControls.appendChild(nextButton);
  }
  function changePage(page) {
      const totalPages = Math.ceil(transactions.length / transactionsPerPage);
      if (page < 1 || page > totalPages) return; 
      currentPage = page;
      renderTransactions(currentPage);
      renderPagination();
  }

  
  renderTransactions(currentPage);
  renderPagination();

  function copyReferral() {
    const copyText = document.getElementById("referralLink");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Referral link copied!");
  }
</script>

<%- include("../../views/partials/user/footer") %>





